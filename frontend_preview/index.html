<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Heartbeat Monitor（离线预览）</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .status-running { color: #198754; font-weight: 600; }
    .status-error { color: #dc3545; font-weight: 600; }
    .status-unknown { color: #6c757d; font-weight: 600; }
    .log-box { max-height: 280px; overflow-y: auto; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }
    .service-row { cursor: pointer; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h3 class="mb-0">内网服务心跳监控中心（离线预览）</h3>
        <div class="text-muted small">本页面为纯前端静态预览，不依赖后端接口</div>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#appInfoModal">项目信息</button>
        <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">刷新</button>
      </div>
    </div>

    <div class="card shadow-sm mb-3">
      <div class="card-header">筛选</div>
      <div class="card-body">
        <div class="row g-2 align-items-end">
          <div class="col-12 col-md-3">
            <label class="form-label mb-1">关键字</label>
            <input class="form-control form-control-sm" id="filterQ" placeholder="服务名/ID/host/检测地址/描述/类别">
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label mb-1">类别</label>
            <select class="form-select form-select-sm" id="filterCategory">
              <option value="all">全部</option>
              <option value="api">API</option>
              <option value="web">网页</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label mb-1">失败策略</label>
            <select class="form-select form-select-sm" id="filterFailure">
              <option value="all">全部</option>
              <option value="alert">仅提示</option>
              <option value="restart">失败重启</option>
            </select>
          </div>
          <div class="col-12 col-md-2">
            <label class="form-label mb-1">状态</label>
            <select class="form-select form-select-sm" id="filterStatus">
              <option value="all">全部</option>
              <option value="running">Running</option>
              <option value="error">Error</option>
              <option value="disabled">Disabled</option>
              <option value="unknown">Unknown</option>
            </select>
          </div>
          <div class="col-12 col-md-1">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="filterOnlyFailed">
              <label class="form-check-label" for="filterOnlyFailed">只看失败服务</label>
            </div>
          </div>
          <div class="col-12 col-md-2 d-flex gap-2 justify-content-md-end">
            <button class="btn btn-primary btn-sm" id="applyFilters">应用</button>
            <button class="btn btn-outline-secondary btn-sm" id="resetFilters">重置</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm mb-3">
      <div class="card-header">服务状态</div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0 align-middle">
            <thead class="table-light">
              <tr>
                <th style="width: 70px;">序号</th>
                <th style="width: 220px;">服务</th>
                <th style="width: 90px;">类别</th>
                <th style="width: 120px;">策略</th>
                <th style="width: 120px;">状态</th>
                <th>检测地址</th>
                <th style="width: 140px;">运行时长</th>
                <th style="width: 120px;">故障率</th>
                <th style="width: 180px;">最后检测</th>
                <th style="width: 240px;">操作</th>
              </tr>
            </thead>
            <tbody id="servicesBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="text-muted small" id="paginationSummary"></div>
      <div class="btn-group btn-group-sm" role="group" aria-label="Pagination">
        <button class="btn btn-outline-secondary" id="pagePrev">上一页</button>
        <button class="btn btn-outline-secondary" id="pageNext">下一页</button>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-header">最近 10 条错误日志</div>
      <div class="card-body">
        <div class="log-box border rounded p-2 bg-white" id="errorsBox"></div>
      </div>
    </div>
  </div>

  <div id="modalsRoot"></div>
  <div class="modal fade" id="appInfoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">项目信息</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12 col-lg-4">
              <div class="border rounded p-3 bg-white">
                <div class="text-muted small">版本</div>
                <div class="fw-semibold">1.2.0</div>
                <div class="mt-2 text-muted small">作者</div>
                <div class="fw-semibold">CC</div>
                <div class="mt-2 text-muted small">更新时间</div>
                <div class="fw-semibold">2026-02-26</div>
              </div>
            </div>
            <div class="col-12 col-lg-8">
              <div class="border rounded p-3 bg-white">
                <div class="fw-semibold mb-2">更新内容（示例）</div>
                <ul class="mb-0">
                  <li>服务列表横向滚动与拖拽滚动</li>
                  <li>筛选增强：关键字/类别/失败策略/状态</li>
                  <li>项目信息弹窗：版本/更新时间/更新记录</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">关闭</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const services = [
      {
        id: "mineru_01",
        name: "Mineru OCR",
        description: "Mineru PDF OCR 转换服务（GPU）",
        category: "api",
        auto_check: true,
        on_failure: "restart",
        can_start: false,
        can_stop: false,
        can_restart: true,
        status: "Running",
        last_check: "2026-02-25 10:30:00",
        last_error: "",
        uptime: "2:13:45",
        failure_rate: "3.12%",
        host: "192.168.1.100",
        test_api: "http://192.168.1.100:8000/ocr",
        config_path: "config/samples/mineru.yaml",
        last_test_detail: { ok: true, status_code: 200, elapsed_ms: 843, response_excerpt: "..." }
      },
      {
        id: "demo_api_01",
        name: "Demo API",
        description: "示例：标准HTTP健康检查 + docker restart",
        category: "api",
        auto_check: true,
        on_failure: "alert",
        can_start: false,
        can_stop: false,
        can_restart: true,
        status: "Error",
        last_check: "2026-02-25 10:30:00",
        last_error: "HTTP 502",
        uptime: "0s",
        failure_rate: "25.00%",
        host: "192.168.1.120",
        test_api: "http://192.168.1.120:9000/health",
        config_path: "config/services/demo_api.yaml",
        last_test_detail: { ok: false, status_code: 502, elapsed_ms: 1200, response_excerpt: "Bad Gateway" }
      },
      {
        id: "portal_web_01",
        name: "业务门户（网页）",
        description: "无API，仅网页可访问性检测；失败仅提示人工处理",
        category: "web",
        auto_check: true,
        on_failure: "alert",
        can_start: false,
        can_stop: false,
        can_restart: false,
        status: "Running",
        last_check: "2026-02-25 10:30:00",
        last_error: "",
        uptime: "12:03:12",
        failure_rate: "1.25%",
        host: "192.168.1.130",
        test_api: "http://192.168.1.130/",
        config_path: "config/services/portal.yaml",
        last_test_detail: { ok: true, status_code: 200, elapsed_ms: 220, response_excerpt: "<html>..." }
      }
    ];

    const errors = [
      { ts: "2026-02-25 10:30:01", service_id: "demo_api_01", service_name: "Demo API", reason: "HTTP 502" },
      { ts: "2026-02-25 10:00:01", service_id: "demo_api_01", service_name: "Demo API", reason: "连接超时" },
      { ts: "2026-02-25 09:30:01", service_id: "mineru_01", service_name: "Mineru OCR", reason: "Expected substring not found: ok" }
    ];

    function statusClass(s) {
      if (s === "Running") return "status-running";
      if (s === "Error") return "status-error";
      return "status-unknown";
    }

    function escapeHtml(x) {
      return String(x)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll("\"", "&quot;")
        .replaceAll("'", "&#039;");
    }

    const state = { q: "", category: "all", on_failure: "all", status: "all", only_failed: false, page: 1, page_size: 5 };
    const serviceIndex = {};

    function policyBadge(s) {
      const policy = !s.auto_check ? "不自动" : (s.on_failure === "restart" ? "失败重启" : "仅提示");
      const cls = !s.auto_check ? "text-bg-secondary" : (s.on_failure === "restart" ? "text-bg-warning" : "text-bg-info");
      return `<span class="badge ${cls}">${escapeHtml(policy)}</span>`;
    }

    function normalizeOpsDoc(doc) {
      if (!doc) return {};
      if (typeof doc === "string") return { notes: doc };
      if (typeof doc === "object") return doc;
      return {};
    }

    function renderLines(value, emptyText) {
      const lines = Array.isArray(value) ? value : (typeof value === "string" ? value.split("\n") : []);
      const clean = lines.map(x => String(x).trim()).filter(Boolean);
      if (!clean.length) return `<div class="text-muted">${escapeHtml(emptyText)}</div>`;
      return `<ul class="mb-0">${clean.map(x => `<li>${escapeHtml(x)}</li>`).join("")}</ul>`;
    }

    function renderPre(value, emptyText) {
      const v = String(value || "").trim();
      if (!v) return `<div class="text-muted">${escapeHtml(emptyText)}</div>`;
      return `<pre class="border rounded p-2 bg-light mb-0" style="white-space: pre-wrap;">${escapeHtml(v)}</pre>`;
    }

    // ===== 扩展点@运维文档模板：固定结构在此调整 =====
    function buildOpsDocHtml(s) {
      const doc = normalizeOpsDoc(s.ops_doc);
      const onFailure = String(s.on_failure || "alert");
      const failureHint = onFailure === "restart" ? "失败后自动重启（可在事件日志查看重启结果）" : "失败仅提示人工处理";
      return `
        <div class="mb-3">
          <div class="fw-semibold mb-2">基础信息</div>
          <div class="row g-2">
            <div class="col-12 col-md-6"><span class="text-muted">服务名：</span>${escapeHtml(s.name || s.id || "")}</div>
            <div class="col-12 col-md-6"><span class="text-muted">服务ID：</span>${escapeHtml(s.id || "")}</div>
            <div class="col-12 col-md-6"><span class="text-muted">类别：</span>${escapeHtml(s.category || "")}</div>
            <div class="col-12 col-md-6"><span class="text-muted">主机：</span>${escapeHtml(s.host || "")}</div>
            <div class="col-12"><span class="text-muted">描述：</span>${escapeHtml(s.description || "")}</div>
          </div>
        </div>
        <div class="mb-3">
          <div class="fw-semibold mb-2">监控与策略</div>
          <div class="row g-2">
            <div class="col-12 col-md-6"><span class="text-muted">检测地址：</span><code>${escapeHtml(s.test_api || "")}</code></div>
            <div class="col-12 col-md-6"><span class="text-muted">检测频率：</span><code>${escapeHtml(s.check_schedule || "") || "30m(默认)"}</code></div>
            <div class="col-12 col-md-6"><span class="text-muted">自动检测：</span>${escapeHtml(String(!!s.auto_check))}</div>
            <div class="col-12 col-md-6"><span class="text-muted">失败策略：</span>${escapeHtml(onFailure)}</div>
          </div>
          <div class="text-muted mt-2">${escapeHtml(doc.monitor || failureHint)}</div>
        </div>
        <div class="mb-3">
          <div class="fw-semibold mb-2">运维操作</div>
          <div class="mb-2"><span class="text-muted">启动：</span>${renderLines(doc.start_steps || s.start_cmds, "未配置")}</div>
          <div class="mb-2"><span class="text-muted">停止：</span>${renderLines(doc.stop_steps || s.stop_cmds, "未配置")}</div>
          <div class="mb-2"><span class="text-muted">重启：</span>${renderLines(doc.restart_steps || s.restart_cmds, "未配置")}</div>
          <div class="mb-2"><span class="text-muted">手工操作：</span>${renderLines(doc.manual_ops, "未配置")}</div>
        </div>
        <div class="mb-3">
          <div class="fw-semibold mb-2">API 文档</div>
          ${renderPre(doc.api_doc, "未配置")}
        </div>
        <div class="mb-3">
          <div class="fw-semibold mb-2">故障处理</div>
          ${renderLines(doc.troubleshooting || doc.fallback, failureHint)}
        </div>
        <div class="mb-0">
          <div class="fw-semibold mb-2">联系人/备注</div>
          <div class="mb-2"><span class="text-muted">联系人：</span>${renderLines(doc.contacts, "未配置")}</div>
          <div><span class="text-muted">备注：</span>${renderLines(doc.notes, "未配置")}</div>
        </div>
      `;
    }

    function openOpsDoc(serviceId) {
      const sid = String(serviceId || "");
      const s = serviceIndex[sid];
      if (!s) return;
      const modalId = "opsDocModal";
      const root = document.getElementById("modalsRoot");
      const exists = document.getElementById(modalId);
      if (exists) exists.remove();
      root.insertAdjacentHTML("beforeend", `
        <div class="modal fade" id="${modalId}" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">${escapeHtml(s.name || s.id || "")} - 运维文档</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                ${buildOpsDocHtml(s)}
              </div>
            </div>
          </div>
        </div>
      `);
      const el = document.getElementById(modalId);
      const modal = new bootstrap.Modal(el);
      el.addEventListener("hidden.bs.modal", () => el.remove(), { once: true });
      modal.show();
    }

    function getFilteredServices() {
      let out = services.slice();
      if (state.q) {
        const q = String(state.q || "").toLowerCase();
        out = out.filter(s => {
          const parts = [s.id, s.name, s.host, s.test_api, s.description, s.category].map(x => String(x || "").toLowerCase());
          return parts.some(x => x.includes(q));
        });
      }
      if (state.category !== "all") out = out.filter(s => String(s.category || "").toLowerCase() === state.category);
      if (state.on_failure !== "all") out = out.filter(s => String(s.on_failure || "").toLowerCase() === state.on_failure);
      if (state.status !== "all") {
        const map = { running: "Running", error: "Error", disabled: "Disabled", unknown: "Unknown" };
        const want = map[state.status] || state.status;
        out = out.filter(s => String(s.status || "") === want);
      }
      if (state.only_failed) out = out.filter(s => String(s.status || "") === "Error");
      return out;
    }

    function renderServices() {
      const filtered = getFilteredServices();
      const total = filtered.length;
      const pages = Math.max(1, Math.ceil(total / state.page_size));
      state.page = Math.min(state.page, pages);
      const start = (state.page - 1) * state.page_size;
      const pageItems = filtered.slice(start, start + state.page_size);

      document.getElementById("paginationSummary").textContent = `第 ${state.page}/${pages} 页（每页 ${state.page_size} 条），共 ${total} 条`;
      document.getElementById("pagePrev").disabled = state.page <= 1;
      document.getElementById("pageNext").disabled = state.page >= pages;

      const body = document.getElementById("servicesBody");
      if (pageItems.length === 0) {
        body.innerHTML = `<tr><td colspan="10" class="text-center text-muted py-4">暂无匹配服务</td></tr>`;
        document.getElementById("modalsRoot").innerHTML = "";
        return;
      }

      pageItems.forEach(s => {
        serviceIndex[String(s.id || "")] = s;
      });
      body.innerHTML = pageItems.map((s, idx) => {
        const seq = start + idx + 1;
        return `
          <tr class="service-row" data-bs-toggle="modal" data-bs-target="#detailModal_${escapeHtml(s.id)}">
            <td class="text-muted">${seq}</td>
            <td>
              <div class="fw-semibold">${escapeHtml(s.name)}</div>
              <div class="text-muted small">${escapeHtml(s.host)}</div>
            </td>
            <td class="text-muted small">${escapeHtml(s.category || "")}</td>
            <td>${policyBadge(s)}</td>
            <td><span class="${statusClass(s.status)}">${escapeHtml(s.status)}</span></td>
            <td class="text-truncate" style="max-width: 360px;">${escapeHtml(s.test_api || "")}</td>
            <td>${escapeHtml(s.uptime)}</td>
            <td>${escapeHtml(s.failure_rate)}</td>
            <td>${escapeHtml(s.last_check)}</td>
            <td>
              <div class="d-flex gap-1" onclick="event.stopPropagation()">
                <button class="btn btn-success btn-sm" ${s.can_start ? "" : "disabled"}>启动</button>
                <button class="btn btn-danger btn-sm" ${s.can_stop ? "" : "disabled"}>停止</button>
                <button class="btn btn-warning btn-sm" ${s.can_restart ? "" : "disabled"}>重启</button>
                <button class="btn btn-info btn-sm" disabled>检测</button>
              </div>
            </td>
          </tr>
        `;
      }).join("");

      const modalsRoot = document.getElementById("modalsRoot");
      modalsRoot.innerHTML = pageItems.map(s => {
        const detail = escapeHtml(JSON.stringify(s.last_test_detail || {}, null, 2));
        return `
          <div class="modal fade" id="detailModal_${escapeHtml(s.id)}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">${escapeHtml(s.name)} 详情</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-2"><span class="text-muted">描述：</span>${escapeHtml(s.description || "")}</div>
                  <div class="mb-2"><span class="text-muted">配置文件：</span><code>${escapeHtml(s.config_path || "")}</code></div>
                  <div class="mb-2"><span class="text-muted">类别：</span><code>${escapeHtml(s.category || "")}</code></div>
                  <div class="mb-2"><span class="text-muted">自动检测：</span><code>${escapeHtml(String(!!s.auto_check))}</code></div>
                  <div class="mb-2"><span class="text-muted">失败策略：</span><code>${escapeHtml(s.on_failure || "")}</code></div>
                  <div class="mb-2"><span class="text-muted">检测地址：</span><code>${escapeHtml(s.test_api || "")}</code></div>
                  <div class="mb-2"><span class="text-muted">API 测试结果：</span></div>
                  <pre class="border rounded p-2 bg-light mb-0" style="white-space: pre-wrap;">${detail}</pre>
                  ${s.last_error ? `<div class="alert alert-danger mt-3 mb-0"><div class="fw-semibold">最后错误</div><div>${escapeHtml(s.last_error)}</div></div>` : ""}
                  <div class="d-flex justify-content-end mt-3">
                    <button class="btn btn-outline-primary btn-sm" onclick="openServiceLogs('${escapeHtml(s.id)}','${escapeHtml(s.name)}')">查看该服务7天错误日志</button>
                    <button class="btn btn-outline-success btn-sm ms-2" onclick="openOpsDoc('${escapeHtml(s.id)}')">运维文档</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join("");
    }

    function openServiceLogs(serviceId, serviceName) {
      const modalId = "serviceLogsModal";
      const items = errors.filter(e => String(e.service_id) === String(serviceId));
      const content = items.length
        ? items.map(e => `<div>[${escapeHtml(e.ts)}] ${escapeHtml(e.reason)}</div>`).join("")
        : `<div class="text-muted">暂无错误日志</div>`;

      const root = document.getElementById("modalsRoot");
      root.insertAdjacentHTML("beforeend", `
        <div class="modal fade" id="${modalId}" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">${escapeHtml(serviceName)} (${escapeHtml(serviceId)}) - 7天错误日志</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="log-box border rounded p-2 bg-white">${content}</div>
              </div>
            </div>
          </div>
        </div>
      `);

      const el = document.getElementById(modalId);
      const modal = new bootstrap.Modal(el);
      el.addEventListener("hidden.bs.modal", () => el.remove(), { once: true });
      modal.show();
    }

    function renderErrors() {
      const box = document.getElementById("errorsBox");
      if (errors.length === 0) {
        box.innerHTML = `<div class="text-muted">暂无错误日志</div>`;
        return;
      }
      box.innerHTML = errors.map(e => {
        return `<div>[${escapeHtml(e.ts)}] <a href="javascript:void(0)" onclick="openServiceLogs('${escapeHtml(e.service_id)}','${escapeHtml(e.service_name)}')">${escapeHtml(e.service_name)} (${escapeHtml(e.service_id)})</a>: ${escapeHtml(e.reason)}</div>`;
      }).join("");
    }

    function bindFilters() {
      document.getElementById("filterQ").onkeydown = (e) => {
        if (e.key !== "Enter") return;
        document.getElementById("applyFilters").click();
      };
      document.getElementById("applyFilters").onclick = () => {
        state.q = String(document.getElementById("filterQ").value || "").trim();
        state.category = document.getElementById("filterCategory").value;
        state.on_failure = document.getElementById("filterFailure").value;
        state.status = document.getElementById("filterStatus").value;
        state.only_failed = document.getElementById("filterOnlyFailed").checked;
        state.page = 1;
        renderServices();
      };
      document.getElementById("resetFilters").onclick = () => {
        document.getElementById("filterQ").value = "";
        document.getElementById("filterCategory").value = "all";
        document.getElementById("filterFailure").value = "all";
        document.getElementById("filterStatus").value = "all";
        document.getElementById("filterOnlyFailed").checked = false;
        state.q = "";
        state.category = "all";
        state.on_failure = "all";
        state.status = "all";
        state.only_failed = false;
        state.page = 1;
        renderServices();
      };
      document.getElementById("pagePrev").onclick = () => {
        if (state.page <= 1) return;
        state.page -= 1;
        renderServices();
      };
      document.getElementById("pageNext").onclick = () => {
        state.page += 1;
        renderServices();
      };
    }

    bindFilters();
    renderServices();
    renderErrors();
  </script>
</body>
</html>
