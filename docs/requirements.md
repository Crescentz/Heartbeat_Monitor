# 项目需求文档 (Requirements)

## 1. 项目概述
本项目旨在开发一个“心跳检测与服务管理工具”（Heartbeat Monitor），用于监测和管理单位内网环境中分布在多台CPU/GPU服务器上的各类API服务（如基于Docker运行的AI模型服务）。该系统集中部署在一台CPU服务器上，提供后端状态监测和前端运维面板。

## 2. 核心功能需求

### 2.1 服务状态监测 (心跳检测)
- **定时检测**: 支持针对不同服务自定义检测周期（例如每半小时）。
- **自定义检测逻辑**: 能够根据服务特性自定义API调用方式、入参（如上传文件）、出参及结果校验逻辑，以判断服务是否健康。
- **状态记录**: 记录服务的当前状态（运行中、异常、未运行）、运行时长、故障率、失败日志等信息。
 - **纳管分类**：支持 API 类/网页类等分类，网页类以“可访问性/关键字”作为检测依据。

### 2.2 跨服务器控制
- **SSH 远程执行**: 系统需要能够通过SSH连接到目标服务器（依赖IP、端口、sudo账号、密码）。
- **Docker 容器管理**: 能够通过SSH执行 `sudo docker` 等命令，实现远程服务的启动、停止、重启、容器销毁等操作。
 - **可选运维**：对于仅监测不运维的服务，不要求配置 SSH 连接信息。

### 2.3 Web 运维面板
- **服务展示列表**: 显示所有受管服务的详细信息，包括：服务名称、服务地址、功能描述、当前状态、运行时长、故障率等。
- **运维操作**: 提供一键启动、一键停止、一键重启功能的按钮。
- **日志查看**: 提供查看各个服务历史失败日志的功能。
 - **策略展示**：显示服务分类与失败策略（仅提示/自动重启），并在无命令配置时禁用对应按钮。

### 2.4 可扩展性与易维护性
- **插件化/模块化设计**: 新增服务时，只需在特定目录下添加少量的配置文件或 Python 脚本，即可被系统自动识别和纳入监控，不影响现有主体代码。
- **容错处理**: 某个服务的检测逻辑发生错误或目标服务器宕机，不得影响心跳检测主程序及 Web 面板的正常运行。
  - 配置文件解析失败或插件加载失败时，应以“配置加载失败”的服务显示在页面中，而不是导致系统退出。

## 3. 配置约定
- 服务配置目录：`config/services/`（每新增服务=新增一个 YAML）
- 推荐方式：仅 YAML 描述检测与启停（通用实现）
- 插件方式：在 YAML 填写 `plugin`，并提供 `services/<plugin>_service.py`（工厂函数 `create_service(...)`）
 - 策略字段：`category/auto_check/on_failure/auto_fix`

详见：
- [docs/config_reference.md](file:///d:/CODE/PyCODE/Heartbeat_Monitor/docs/config_reference.md)
- [docs/extending.md](file:///d:/CODE/PyCODE/Heartbeat_Monitor/docs/extending.md)

## 4. 首个对接服务要求：Mineru
- **检测逻辑**: 定时（如每半小时）向 Mineru API 上传预定义的 PDF 文件，若成功返回 OCR 解析结果则认为服务正常。
- **故障恢复逻辑**: 发现异常后，记录错误日志 -> SSH登录目标服务器 -> 销毁现有 Mineru 容器 -> 重新执行 Docker 启动命令。
- **Docker 启动命令**:
  `sudo docker run --gpus all --shm-size 32g -p 30000:30000 -p 7860:7860 -p 8000:8000 --ipc=host -itd mineru:latest /bin/bash`
- **容器内服务启动命令**:
  设置环境变量 `MINERU_MODEL_SOURCE=local`，执行 `nohup mineru-api --host 0.0.0.0 --port 8000 > /vllm-workspace/api.log 2>&1 &`
