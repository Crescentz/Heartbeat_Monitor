<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>内网服务心跳监控</title>
  <link href="{{ url_for('static', filename='vendor/bootstrap/css/bootstrap.min.css') }}" rel="stylesheet">
  <style>
    :root {
      --hb-border: rgba(0,0,0,.08);
      --hb-bg-a: #f7faf7;
      --hb-bg-b: #eef4ff;
      --hb-shadow: 0 8px 26px rgba(15, 23, 42, 0.08);
    }
    body {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
      background: radial-gradient(circle at 0% 0%, var(--hb-bg-b), transparent 38%),
                  radial-gradient(circle at 100% 100%, #eaf7f2, transparent 36%),
                  linear-gradient(180deg, var(--hb-bg-a), #f7f9fc);
    }
    .status-pill { display: inline-block; padding: 4px 12px; border-radius: 999px; font-weight: 800; letter-spacing: .2px; font-size: 13px; }
    .status-running { color: #0f5132; background: rgba(25,135,84,.22); border: 1px solid rgba(25,135,84,.42); }
    .status-error { color: #842029; background: rgba(220,53,69,.22); border: 1px solid rgba(220,53,69,.42); }
    .status-disabled { color: #41464b; background: rgba(108,117,125,.18); border: 1px solid rgba(108,117,125,.38); }
    .status-unknown { color: #7a4a00; background: rgba(255,193,7,.20); border: 1px solid rgba(255,153,0,.45); }
    .log-box { max-height: 280px; overflow-y: auto; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }
    .service-row { cursor: pointer; }
    .table-responsive { overflow-x: auto; overflow-y: hidden; width: 100%; -webkit-overflow-scrolling: touch; scrollbar-gutter: stable; }
    #servicesHScrollTop { overflow-x: auto; overflow-y: hidden; width: 100%; height: 14px; scrollbar-gutter: stable; background: rgba(248,249,250,0.6); }
    #servicesHScrollTopInner { height: 1px; }
    #servicesTable { min-width: 2050px; width: max-content; table-layout: fixed; }
    #servicesTable thead th { position: sticky; top: 0; z-index: 2; background: rgba(248,249,250,0.98); }
    .col-resizer { position: absolute; top: 0; right: 0; width: 8px; height: 100%; cursor: col-resize; user-select: none; }
    .col-resizer::after { content: ""; position: absolute; top: 0; left: 3px; width: 2px; height: 100%; background: rgba(0,0,0,0.08); }
    .card { border-color: var(--hb-border); box-shadow: var(--hb-shadow); }
    .card-header { background: rgba(248,249,250,.9); border-bottom-color: var(--hb-border); font-weight: 600; }
    .table { font-size: 13px; }
    .table thead th { white-space: nowrap; }
    .table tbody tr:hover { background: rgba(13,110,253,.05); }
    .table td { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    td.td-actions { overflow: visible; white-space: normal; }
    td.td-status { overflow: visible; white-space: normal; }
    td.td-runtime-status { overflow: visible; white-space: normal; }
    .status-admin-row .btn { padding: 1px 8px; line-height: 1.25; }
    .maint-btn-partial { background: #f8f9fa; color: #6c757d; border-color: #ced4da; opacity: .9; }
    .maint-btn-blocked { background: #adb5bd; color: #fff; border-color: #adb5bd; opacity: .95; }
    .topbar { position: sticky; top: 0; z-index: 30; padding-top: 1rem; background: rgba(248,249,250,.72); backdrop-filter: blur(10px); }
    .topbar-inner { background: rgba(255,255,255,.92); }
  </style>
</head>
<body class="bg-light">
  <div class="container-fluid py-4 px-4" style="max-width: 1900px;">
    <div class="topbar mb-3">
      <div class="d-flex justify-content-between align-items-center p-3 border rounded shadow-sm topbar-inner">
      <div>
        <h3 class="mb-0">内网服务心跳监控中心</h3>
        <div class="text-muted small">服务数量：<span id="serviceCount">-</span> · 最后刷新：<span id="lastRefresh">-</span></div>
      </div>
      <div class="d-flex gap-2">
        <div class="text-muted small align-self-center">用户：{{ user.username }}{% if user.role == "admin" %}（超管）{% else %}{% if user.can_control %}（可运维）{% else %}（只监控）{% endif %}{% endif %}</div>
        <button class="btn btn-outline-secondary btn-sm" id="changeMyPwd">改密码</button>
        {% if user.role == "admin" %}
        <div class="btn-group">
          <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">一键切换</button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="javascript:void(0)" id="bulkEnableCapable">支持维护→可维护</a></li>
            <li><a class="dropdown-item" href="javascript:void(0)" id="bulkDisableAll">全部→只监控</a></li>
            <li><a class="dropdown-item" href="javascript:void(0)" id="bulkEnableAll">全部→可维护</a></li>
          </ul>
        </div>
        <button class="btn btn-outline-primary btn-sm" id="openAdmin">管理</button>
        {% endif %}
        <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#appInfoModal">项目信息</button>
        <a class="btn btn-outline-secondary btn-sm" href="/logout">退出</a>
        <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">刷新</button>
      </div>
    </div>
    </div>

    <div class="card shadow-sm mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div>筛选</div>
        <div class="d-flex gap-2">
          <button class="btn btn-primary btn-sm" id="applyFilters">应用</button>
          <button class="btn btn-outline-secondary btn-sm" id="resetFilters">重置</button>
        </div>
      </div>
      <div class="card-body">
        <div class="row g-2 align-items-end">
          <div class="col-12 col-md-3">
            <label class="form-label mb-1">关键字</label>
            <input class="form-control form-control-sm" id="filterQ" placeholder="服务名/ID/host/检测地址/描述/类别">
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label mb-1">类别</label>
            <select class="form-select form-select-sm" id="filterCategory">
              <option value="all">全部</option>
              <option value="api">API</option>
              <option value="web">网页</option>
              <option value="other">其他</option>
            </select>
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label mb-1">失败策略</label>
            <select class="form-select form-select-sm" id="filterFailure">
              <option value="all">全部</option>
              <option value="alert">失败告警</option>
              <option value="restart">自动重启</option>
            </select>
          </div>
          <div class="col-12 col-md-2">
            <label class="form-label mb-1">状态</label>
            <select class="form-select form-select-sm" id="filterStatus">
              <option value="all">全部</option>
              <option value="running">运行</option>
              <option value="error">异常</option>
              <option value="disabled">禁用</option>
              <option value="unknown">未知</option>
            </select>
          </div>
          <div class="col-12 col-md-1">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="filterOnlyFailed">
              <label class="form-check-label" for="filterOnlyFailed">只看失败服务</label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm mb-3">
      <div class="card-header">服务状态</div>
      <div class="card-body p-0">
        <div id="servicesHScrollTop" style="display:none;"><div id="servicesHScrollTopInner"></div></div>
        <div class="table-responsive" id="servicesTableWrap">
          <table class="table table-hover mb-0 align-middle" id="servicesTable">
            <thead class="table-light">
              <tr>
                <th style="width: 70px;">序号</th>
                <th style="width: 220px;">服务</th>
                <th style="width: 90px;">类别</th>
                <th style="width: 120px;">运行状态</th>
                <th style="width: 430px;">操作状态</th>
                <th style="width: 360px;">检测地址</th>
                <th style="width: 140px;">运行时长</th>
                <th style="width: 120px;">故障率</th>
                <th style="width: 180px;">最后检测</th>
                <th style="width: 300px;">服务维护</th>
              </tr>
            </thead>
            <tbody id="servicesBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="text-muted small" id="paginationSummary"></div>
      <div class="d-flex gap-2 align-items-center">
        <select class="form-select form-select-sm" id="pageSize" style="width: 120px;">
          <option value="5">每页 5</option>
          <option value="10">每页 10</option>
          <option value="20">每页 20</option>
        </select>
        <div class="btn-group btn-group-sm" role="group" aria-label="Pagination">
          <button class="btn btn-outline-secondary" id="pagePrev">上一页</button>
          <button class="btn btn-outline-secondary" id="pageNext">下一页</button>
        </div>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabErrors" type="button" role="tab">错误日志</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabEvents" type="button" role="tab">事件日志</button>
          </li>
        </ul>
      </div>
      <div class="card-body">
        <div class="tab-content">
          <div class="tab-pane fade show active" id="tabErrors" role="tabpanel">
            <div class="log-box border rounded p-2 bg-white" id="errorsBox"></div>
          </div>
          <div class="tab-pane fade" id="tabEvents" role="tabpanel">
            <div class="log-box border rounded p-2 bg-white" id="eventsBox"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="detailModalsRoot"></div>
  <div id="overlayModalsRoot"></div>
  <div class="modal fade" id="appInfoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">项目信息</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12 col-lg-4">
              <div class="border rounded p-3 bg-white">
                <div class="text-muted small">版本</div>
                <div class="fw-semibold">{{ app_info.version }}</div>
                <div class="mt-2 text-muted small">作者</div>
                <div class="fw-semibold">{{ app_info.author }}</div>
                <div class="mt-2 text-muted small">更新时间</div>
                <div class="fw-semibold">{{ app_info.updated_at }}</div>
              </div>
            </div>
            <div class="col-12 col-lg-8">
              <div class="border rounded p-3 bg-white">
                <div class="fw-semibold mb-2">{{ app_info.latest.title }}</div>
                <ul class="mb-0">
                  {% for x in app_info.latest["items"] %}
                  <li>{{ x }}</li>
                  {% endfor %}
                </ul>
                <div class="mt-3">
                  <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#changelogCollapse">历史更新</button>
                </div>
                <div class="collapse mt-2" id="changelogCollapse">
                  <div class="border rounded p-2 bg-light">
                    {% for h in app_info.history %}
                    <div class="mb-2">
                      <div class="fw-semibold">{{ h.version }} · {{ h.date }}</div>
                      <ul class="mb-0">
                        {% for it in h["items"] %}
                        <li>{{ it }}</li>
                        {% endfor %}
                      </ul>
                    </div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">关闭</button>
        </div>
      </div>
    </div>
  </div>

  <script src="{{ url_for('static', filename='vendor/bootstrap/js/bootstrap.bundle.min.js') }}"></script>
  <script>
    const currentUser = {{ user | tojson }};

    function escapeHtml(x) {
      return String(x)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll("\"", "&quot;")
        .replaceAll("'", "&#039;");
    }

    function statusClass(s) {
      if (s === "Running") return "status-running";
      if (s === "Error") return "status-error";
      if (s === "Disabled") return "status-disabled";
      return "status-unknown";
    }

    function statusLabel(s) {
      if (s === "Running") return "运行";
      if (s === "Error") return "异常";
      if (s === "Disabled") return "禁用";
      return "未知";
    }

    function failurePolicyLabel(v) {
      const s = String(v || "").toLowerCase();
      if (s === "restart") return "失败自动重启";
      return "失败告警";
    }

    function safeId(s) {
      return String(s).replaceAll(/[^a-zA-Z0-9_-]/g, "_");
    }

    function initResizableColumns(tableId, storageKey) {
      const table = document.getElementById(tableId);
      if (!table) return;
      const header = table.querySelector("thead tr");
      if (!header) return;
      const ths = Array.from(header.querySelectorAll("th"));

      const saved = (() => {
        try { return JSON.parse(localStorage.getItem(storageKey) || "{}"); } catch { return {}; }
      })();
      ths.forEach((th, idx) => {
        const w = saved[String(idx)];
        if (w && Number.isFinite(w)) th.style.width = `${w}px`;
      });

      ths.forEach((th, idx) => {
        if (th.querySelector(".col-resizer")) return;
        const resizer = document.createElement("div");
        resizer.className = "col-resizer";
        th.appendChild(resizer);

        resizer.addEventListener("mousedown", (e) => {
          e.preventDefault();
          const startX = e.clientX;
          const startW = th.getBoundingClientRect().width;

          const onMove = (ev) => {
            const next = Math.max(50, Math.round(startW + (ev.clientX - startX)));
            th.style.width = `${next}px`;
          };
          const onUp = () => {
            const widths = {};
            ths.forEach((x, i) => {
              widths[String(i)] = Math.round(x.getBoundingClientRect().width);
            });
            try { localStorage.setItem(storageKey, JSON.stringify(widths)); } catch {}
            updateServicesHScroll();
            window.removeEventListener("mousemove", onMove);
            window.removeEventListener("mouseup", onUp);
          };

          window.addEventListener("mousemove", onMove);
          window.addEventListener("mouseup", onUp);
        });
      });
    }

    const state = {
      q: "",
      category: "all",
      on_failure: "all",
      status: "all",
      only_failed: false,
      page: 1,
      page_size: 10
    };
    const serviceIndex = {};

    function updateServicesHScroll() {
      const wrap = document.getElementById("servicesTableWrap");
      const table = document.getElementById("servicesTable");
      const top = document.getElementById("servicesHScrollTop");
      const inner = document.getElementById("servicesHScrollTopInner");
      if (!wrap || !table || !top || !inner) return;
      const w = Math.max(table.scrollWidth || 0, 0);
      inner.style.width = `${w}px`;
      const need = w > (wrap.clientWidth || 0) + 2;
      top.style.display = need ? "block" : "none";
      if (need) top.scrollLeft = wrap.scrollLeft;
    }

    function initServicesHScrollSync() {
      const wrap = document.getElementById("servicesTableWrap");
      const top = document.getElementById("servicesHScrollTop");
      const table = document.getElementById("servicesTable");
      if (!wrap || !top || !table) return;
      if (wrap.dataset.hscrollSync === "1") return;
      wrap.dataset.hscrollSync = "1";
      let syncing = false;
      wrap.addEventListener("scroll", () => {
        if (syncing) return;
        syncing = true;
        top.scrollLeft = wrap.scrollLeft;
        syncing = false;
      });
      top.addEventListener("scroll", () => {
        if (syncing) return;
        syncing = true;
        wrap.scrollLeft = top.scrollLeft;
        syncing = false;
      });
      window.addEventListener("resize", () => {
        updateServicesHScroll();
      });
      updateServicesHScroll();
    }

    function operationStatusBadges(s, scheduleText) {
      const parts = [];
      parts.push(s.auto_check ? `<span class="badge text-bg-primary">自动检测：开</span>` : `<span class="badge text-bg-secondary">自动检测：关</span>`);
      parts.push(`<span class="badge bg-light text-dark border">频率：${escapeHtml(scheduleText)}</span>`);
      if (s.ops_capable) {
        parts.push(s.ops_enabled ? `<span class="badge text-bg-success">服务维护：可维护</span>` : `<span class="badge text-bg-secondary">服务维护：只监控</span>`);
      } else {
        parts.push(`<span class="badge bg-light border text-secondary">服务维护：不可维护</span>`);
      }
      if (String(s.on_failure || "").toLowerCase() === "restart") {
        parts.push(s.auto_restart_effective ? `<span class="badge text-bg-warning">自动重启：开</span>` : `<span class="badge bg-light border text-secondary">自动重启：受限</span>`);
      } else {
        parts.push(`<span class="badge text-bg-info">自动重启：关</span>`);
      }
      if (s.disabled) parts.push(`<span class="badge text-bg-dark">已禁用</span>`);
      return parts.join("");
    }

    function operationAdminActions(s, sidJson, autoCheck, opsEnabled, opsCapable, disabled) {
      if (!(currentUser && currentUser.role === "admin")) return "";
      const autoRestart = String(s.on_failure || "").toLowerCase() === "restart";
      const onlyMonitorLabel = "切到只监控";
      return `
        <div class="d-flex flex-wrap gap-1 mt-1 status-admin-row no-detail" onclick="event.stopPropagation()">
          <button class="btn btn-outline-primary btn-sm" ${disabled ? "disabled" : ""} onclick='event.stopPropagation(); toggleAutoCheckRow(${sidJson}, ${autoCheck ? "false" : "true"})'>${autoCheck ? "关闭自动检测" : "开启自动检测"}</button>
          <button class="btn btn-outline-primary btn-sm" ${disabled ? "disabled" : ""} onclick='event.stopPropagation(); editScheduleRow(${sidJson})'>修改频率</button>
          ${s.restart_capable ? `<button class="btn btn-outline-info btn-sm" ${disabled ? "disabled" : ""} onclick='event.stopPropagation(); toggleAutoRestartRow(${sidJson}, ${autoRestart ? "false" : "true"})'>${autoRestart ? "自动重启关" : "自动重启开"}</button>` : ""}
          ${opsCapable ? `<button class="btn btn-outline-warning btn-sm" ${disabled ? "disabled" : ""} onclick='event.stopPropagation(); toggleOpsMode(${sidJson}, ${opsEnabled ? "false" : "true"})'>${opsEnabled ? onlyMonitorLabel : "恢复可维护"}</button>` : ""}
          <button class="btn btn-outline-dark btn-sm" onclick='event.stopPropagation(); toggleDisabled(${sidJson}, ${disabled ? "false" : "true"})'>${disabled ? "启用服务" : "禁用服务"}</button>
        </div>
      `;
    }

    function renderMaintButton(sidJson, action, label, state, mark, styleClass) {
      const s = String(state || "blocked");
      const m = String(mark || (s === "ok" ? "√" : (s === "partial" ? "-" : "x")));
      if (s !== "ok") {
        const cls = s === "partial"
          ? "btn btn-sm border maint-btn-partial"
          : "btn btn-sm maint-btn-blocked";
        return `<button class="${cls}" disabled>${m}${label}</button>`;
      }
      return `<button class="${styleClass}" onclick='event.stopPropagation(); showActionModal(${sidJson},"${action}")'>${m}${label}</button>`;
    }

    function maintenanceActionButtons(s, sidJson) {
      return [
        renderMaintButton(sidJson, "start", "启动", s.action_state_start, s.action_mark_start, "btn btn-success btn-sm"),
        renderMaintButton(sidJson, "stop", "停止", s.action_state_stop, s.action_mark_stop, "btn btn-danger btn-sm"),
        renderMaintButton(sidJson, "restart", "重启", s.action_state_restart, s.action_mark_restart, "btn btn-warning btn-sm"),
        renderMaintButton(sidJson, "check", "检测", s.action_state_check, s.action_mark_check, "btn btn-info btn-sm"),
      ].join("");
    }

    function normalizeOpsDoc(doc) {
      if (!doc) return {};
      if (typeof doc === "string") return { notes: doc };
      if (typeof doc === "object") return doc;
      return {};
    }

    function renderLines(value, emptyText) {
      const lines = Array.isArray(value) ? value : (typeof value === "string" ? value.split("\n") : []);
      const clean = lines.map(x => String(x).trim()).filter(Boolean);
      if (!clean.length) return `<div class="text-muted">${escapeHtml(emptyText)}</div>`;
      return `<ul class="mb-0">${clean.map(x => `<li>${escapeHtml(x)}</li>`).join("")}</ul>`;
    }

    function renderPre(value, emptyText) {
      const v = String(value || "").trim();
      if (!v) return `<div class="text-muted">${escapeHtml(emptyText)}</div>`;
      return `<pre class="border rounded p-2 bg-light mb-0" style="white-space: pre-wrap;">${escapeHtml(v)}</pre>`;
    }

    // ===== 扩展点@运维文档模板：固定结构在此调整 =====
    function buildOpsDocHtml(s) {
      const doc = normalizeOpsDoc(s.ops_doc);
      const onFailure = String(s.on_failure || "alert");
      const autoRestart = !!s.auto_restart;
      const failureHint = autoRestart ? "失败后自动重启（可在事件日志查看重启结果）" : "失败仅提醒人工处理";
      return `
        <div class="mb-3">
          <div class="fw-semibold mb-2">基础信息</div>
          <div class="row g-2">
            <div class="col-12 col-md-6"><span class="text-muted">服务名：</span>${escapeHtml(s.name || s.id || "")}</div>
            <div class="col-12 col-md-6"><span class="text-muted">服务ID：</span>${escapeHtml(s.id || "")}</div>
            <div class="col-12 col-md-6"><span class="text-muted">类别：</span>${escapeHtml(s.category || "")}</div>
            <div class="col-12 col-md-6"><span class="text-muted">主机：</span>${escapeHtml(s.host || "")}</div>
            <div class="col-12"><span class="text-muted">描述：</span>${escapeHtml(s.description || "")}</div>
          </div>
        </div>
        <div class="mb-3">
          <div class="fw-semibold mb-2">监控与策略</div>
          <div class="row g-2">
            <div class="col-12 col-md-6"><span class="text-muted">检测地址：</span><code>${escapeHtml(s.test_api || "")}</code></div>
            <div class="col-12 col-md-6"><span class="text-muted">检测频率：</span><code>${escapeHtml(s.check_schedule || "") || "30m(默认)"}</code></div>
            <div class="col-12 col-md-6"><span class="text-muted">自动检测：</span>${escapeHtml(String(!!s.auto_check))}</div>
            <div class="col-12 col-md-6"><span class="text-muted">失败策略：</span>${escapeHtml(failurePolicyLabel(onFailure))}</div>
          </div>
          <div class="text-muted mt-2">${escapeHtml(doc.monitor || failureHint)}</div>
        </div>
        <div class="mb-3">
          <div class="fw-semibold mb-2">运维操作</div>
          <div class="mb-2"><span class="text-muted">启动：</span>${renderLines(doc.start_steps || s.start_cmds, "未配置")}</div>
          <div class="mb-2"><span class="text-muted">停止：</span>${renderLines(doc.stop_steps || s.stop_cmds, "未配置")}</div>
          <div class="mb-2"><span class="text-muted">重启：</span>${renderLines(doc.restart_steps || s.restart_cmds, "未配置")}</div>
          <div class="mb-2"><span class="text-muted">手工操作：</span>${renderLines(doc.manual_ops, "未配置")}</div>
        </div>
        <div class="mb-3">
          <div class="fw-semibold mb-2">API 文档</div>
          ${renderPre(doc.api_doc, "未配置")}
        </div>
        <div class="mb-3">
          <div class="fw-semibold mb-2">故障处理</div>
          ${renderLines(doc.troubleshooting || doc.fallback, failureHint)}
        </div>
        <div class="mb-0">
          <div class="fw-semibold mb-2">联系人/备注</div>
          <div class="mb-2"><span class="text-muted">联系人：</span>${renderLines(doc.contacts, "未配置")}</div>
          <div><span class="text-muted">备注：</span>${renderLines(doc.notes, "未配置")}</div>
        </div>
      `;
    }

    function openOpsDoc(serviceId) {
      const sid = String(serviceId || "");
      const s = serviceIndex[sid];
      if (!s) return;
      const modalId = "opsDocModal";
      const root = document.getElementById("overlayModalsRoot");
      const exists = document.getElementById(modalId);
      if (exists) exists.remove();
      root.insertAdjacentHTML("beforeend", `
        <div class="modal fade" id="${modalId}" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">${escapeHtml(s.name || s.id || "")} - 运维文档</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                ${buildOpsDocHtml(s)}
              </div>
            </div>
          </div>
        </div>
      `);
      const el = document.getElementById(modalId);
      const modal = bootstrap.Modal.getOrCreateInstance(el);
      el.addEventListener("hidden.bs.modal", () => el.remove(), { once: true });
      modal.show();
    }

    function openDetailModal(ev, serviceId) {
      if (state.dragScrolling) return;
      const id = `detailModal_${safeId(serviceId)}`;
      const el = document.getElementById(id);
      if (!el) return;
      const modal = bootstrap.Modal.getOrCreateInstance(el);
      modal.show();
    }

    function renderServices(services, total, pages) {
      document.getElementById("serviceCount").textContent = String(total);
      const summary = `第 ${state.page}/${pages || 1} 页（每页 ${state.page_size} 条），共 ${total} 条`;
      document.getElementById("paginationSummary").textContent = summary;

      const body = document.getElementById("servicesBody");
      if (!services || services.length === 0) {
        body.innerHTML = `<tr><td colspan="10" class="text-center text-muted py-4">暂无匹配服务</td></tr>`;
        document.getElementById("detailModalsRoot").innerHTML = "";
        return;
      }

      services.forEach(s => {
        serviceIndex[String(s.id || "")] = s;
      });
      body.innerHTML = services.map((s, idx) => {
        const seq = (state.page - 1) * state.page_size + idx + 1;
        const cat = escapeHtml(s.category || "");
        const testApi = escapeHtml(s.test_api || "");
        const host = escapeHtml(s.host || "");
        const name = escapeHtml(s.name || s.id || "");
        const sched = String(s.check_schedule || "").trim();
        const baseSched = String(s.base_check_schedule || "").trim();
        const sidJson = JSON.stringify(String(s.id || ""));
        const disabled = !!s.disabled;
        const opsEnabled = !!s.ops_enabled;
        const opsCapable = !!s.ops_capable;
        const statusText = disabled ? "Disabled" : (s.status || "");
        const statusCls = statusClass(statusText);
        const statusTextCn = statusLabel(statusText);
        const autoCheck = !!s.auto_check;
        const scheduleText = autoCheck ? (sched || baseSched || "30m(默认)") : "off";
        return `
          <tr class="service-row" onclick='openDetailModal(event, ${sidJson})'>
            <td class="text-muted">${seq}</td>
            <td>
              <div class="fw-semibold">${name}</div>
              <div class="text-muted small">${host}</div>
            </td>
            <td class="text-muted small">${cat}</td>
            <td class="td-runtime-status">
              <span class="status-pill ${statusCls}">${escapeHtml(statusTextCn)}</span>
            </td>
            <td class="td-status">
              <div class="d-flex flex-column gap-1">
                <div class="d-flex flex-wrap gap-1">${operationStatusBadges(s, scheduleText)}</div>
                ${operationAdminActions(s, sidJson, autoCheck, opsEnabled, opsCapable, disabled)}
              </div>
            </td>
            <td class="text-truncate" style="max-width: 360px;">${testApi}</td>
            <td>${escapeHtml(s.uptime || "")}</td>
            <td>${escapeHtml(s.failure_rate || "")}</td>
            <td>${escapeHtml(s.last_check || "")}</td>
            <td class="td-actions">
              <div class="d-flex flex-wrap gap-1 no-detail" onclick="event.stopPropagation()">
                ${maintenanceActionButtons(s, sidJson)}
              </div>
            </td>
          </tr>
        `;
      }).join("");
      initServicesHScrollSync();
      updateServicesHScroll();

      const anyModalOpen = !!document.querySelector(".modal.show");
      if (anyModalOpen) return;

      const modalsRoot = document.getElementById("detailModalsRoot");
      modalsRoot.innerHTML = services.map(s => {
        const detail = escapeHtml(JSON.stringify(s.last_test_detail || {}, null, 2));
        const sidJson = JSON.stringify(String(s.id || ""));
        const nameJson = JSON.stringify(String(s.name || s.id || ""));
        const modalDomId = `detailModal_${safeId(s.id || "")}`;
        return `
          <div class="modal fade" id="${modalDomId}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">${escapeHtml(s.name || s.id)} 详情</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-2"><span class="text-muted">描述：</span>${escapeHtml(s.description || "")}</div>
                  <div class="mb-2"><span class="text-muted">配置文件：</span><code>${escapeHtml(s.config_path || "")}</code></div>
                  <div class="mb-2"><span class="text-muted">类别：</span><code>${escapeHtml(s.category || "")}</code></div>
                  <div class="mb-2"><span class="text-muted">自动检测：</span><code>${escapeHtml(String(!!s.auto_check))}</code></div>
                  <div class="mb-2"><span class="text-muted">检测频率：</span><code>${escapeHtml(s.check_schedule || "") || "30m(默认)"}</code></div>
                  <div class="mb-2"><span class="text-muted">失败策略：</span><code>${escapeHtml(s.on_failure || "")}</code></div>
                  <div class="mb-2"><span class="text-muted">服务维护：</span><code>${escapeHtml(s.ops_enabled ? "可维护" : "只监控")}</code></div>
                  <div class="mb-2"><span class="text-muted">检测地址：</span><code>${escapeHtml(s.test_api || "")}</code></div>
                  <div class="mb-2"><span class="text-muted">API 测试结果：</span></div>
                  <pre class="border rounded p-2 bg-light mb-0" style="white-space: pre-wrap;">${detail}</pre>
                  ${s.last_error ? `<div class="alert alert-danger mt-3 mb-0"><div class="fw-semibold">最后错误</div><div>${escapeHtml(s.last_error)}</div></div>` : ""}
                  <div class="d-flex justify-content-end mt-3">
                    <button class="btn btn-outline-primary btn-sm" onclick='openServiceLogs(${sidJson},${nameJson})'>查看该服务7天错误日志</button>
                    <button class="btn btn-outline-secondary btn-sm ms-2" onclick='openServiceEventLogs(${sidJson},${nameJson})'>查看该服务7天事件日志</button>
                    <button class="btn btn-outline-success btn-sm ms-2" onclick='openOpsDoc(${sidJson})'>运维文档</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join("");
    }

    async function fetchJson(url, options) {
      const resp = await fetch(url, options || {});
      if (resp.status === 401) {
        location.href = "/login";
        throw new Error("unauthorized");
      }
      const text = await resp.text();
      let data = {};
      try {
        data = text ? JSON.parse(text) : {};
      } catch {
        data = {};
      }
      if (!resp.ok) {
        throw new Error(data.error || data.message || `HTTP ${resp.status}`);
      }
      if (Object.prototype.hasOwnProperty.call(data, "success") && data.success === false) {
        throw new Error(data.message || "failed");
      }
      return data;
    }

    const actionState = { service_id: "", action: "", open: false, timer: null };

    async function showActionModal(serviceId, action) {
      actionState.service_id = String(serviceId || "");
      actionState.action = String(action || "");
      ensureActionModal();
      updateActionModal({ title: `操作：${escapeHtml(actionState.action)} - ${escapeHtml(actionState.service_id)}`, status: "执行中...", message: "" });
      const modalEl = document.getElementById("actionModal");
      const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
      modal.show();

      if (actionState.timer) {
        clearInterval(actionState.timer);
        actionState.timer = null;
      }
      actionState.open = true;
      actionState.timer = setInterval(() => {
        if (!actionState.open) return;
        refreshActionModalLogs().catch(() => {});
      }, 1000);

      try {
        await refreshActionModalLogs();
        const url = `/api/control/${encodeURIComponent(actionState.service_id)}/${encodeURIComponent(actionState.action)}`;
        const data = await fetchJson(url, { method: "POST" });
        updateActionModal({ status: "已提交", message: escapeHtml(data.message || "ok") });
        await loadAll();
        await refreshActionModalLogs();
      } catch (e) {
        updateActionModal({ status: "失败", message: escapeHtml(String(e && e.message ? e.message : e)) });
      }
    }

    function ensureActionModal() {
      if (document.getElementById("actionModal")) return;
      const root = document.getElementById("overlayModalsRoot");
      root.insertAdjacentHTML("beforeend", `
        <div class="modal fade" id="actionModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="actionModalTitle">操作</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div class="text-muted small">状态：<span id="actionModalStatus">-</span></div>
                  <div class="text-muted small">服务：<code id="actionModalService">-</code></div>
                </div>
                <div class="alert alert-light border mb-3">
                  <div class="fw-semibold mb-1">返回信息</div>
                  <div id="actionModalMessage" class="small text-break">-</div>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div class="fw-semibold">最近事件</div>
                  <button class="btn btn-outline-secondary btn-sm" id="actionModalRefreshBtn">刷新</button>
                </div>
                <div class="log-box border rounded p-2 bg-white" id="actionModalEventsBox"></div>
              </div>
            </div>
          </div>
        </div>
      `);
      document.getElementById("actionModalRefreshBtn").onclick = async () => {
        await refreshActionModalLogs();
      };
      document.getElementById("actionModal").addEventListener("hidden.bs.modal", () => {
        actionState.open = false;
        if (actionState.timer) {
          clearInterval(actionState.timer);
          actionState.timer = null;
        }
      });
    }

    function updateActionModal(patch) {
      if (!document.getElementById("actionModal")) return;
      if (patch.title !== undefined) document.getElementById("actionModalTitle").textContent = patch.title;
      document.getElementById("actionModalService").textContent = actionState.service_id || "-";
      if (patch.status !== undefined) document.getElementById("actionModalStatus").textContent = patch.status;
      if (patch.message !== undefined) document.getElementById("actionModalMessage").innerHTML = patch.message || "-";
    }

    async function refreshActionModalLogs() {
      if (!actionState.service_id) return;
      const qs = new URLSearchParams({ service_id: actionState.service_id, page: "1", page_size: "30", days: "7" });
      const data = await fetchJson(`/api/events?${qs.toString()}`);
      const items = data.events || [];
      const box = document.getElementById("actionModalEventsBox");
      if (!box) return;
      box.innerHTML = items.length
        ? items.map(e => `<div>[${escapeHtml(e.ts || "")}] [${escapeHtml(String(e.level || "").toUpperCase())}] ${escapeHtml(e.action || "")}: ${escapeHtml(e.message || "")}</div>`).join("")
        : `<div class="text-muted">暂无事件</div>`;
    }

    async function toggleDisabled(serviceId, disabled) {
      const sid = String(serviceId || "");
      await fetchJson("/api/admin/disabled", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ service_id: sid, disabled: !!disabled })
      });
      await loadAll();
    }

    async function toggleOpsMode(serviceId, opsEnabled) {
      const sid = String(serviceId || "");
      await fetchJson("/api/admin/ops_mode", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ service_id: sid, ops_enabled: !!opsEnabled })
      });
      await loadAll();
    }

    async function bulkSetOpsMode(mode) {
      const m = String(mode || "");
      const tips = {
        enable_capable: "将所有“支持维护”的服务切换为可维护，其余保持只监控。确认继续？",
        disable_all: "将所有服务切换为只监控（会阻断自动重启执行）。确认继续？",
        enable_all: "将所有服务切换为可维护。确认继续？"
      };
      if (!confirm(tips[m] || "确认继续？")) return;
      await fetchJson("/api/admin/ops_mode/bulk", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ mode: m })
      });
      await loadAll();
    }

    async function fetchServices() {
      const qs = new URLSearchParams({
        q: state.q,
        category: state.category,
        on_failure: state.on_failure,
        status: state.status,
        only_failed: state.only_failed ? "1" : "0",
        page: String(state.page),
        page_size: String(state.page_size)
      });
      return await fetchJson(`/api/services?${qs.toString()}`);
    }

    async function fetchRecentErrors() {
      return await fetchJson(`/api/errors?n=10&days=7`);
    }

    async function fetchRecentEvents() {
      return await fetchJson(`/api/events?n=30&days=7`);
    }

    function renderErrors(errors) {
      const box = document.getElementById("errorsBox");
      if (!errors || errors.length === 0) {
        box.innerHTML = `<div class="text-muted">暂无错误日志</div>`;
        return;
      }
      box.innerHTML = errors.map(e => {
        const sid = String(e.service_id || "");
        const sname = String(e.service_name || "");
        const sidHtml = escapeHtml(sid);
        const snameHtml = escapeHtml(sname);
        const sidJson = JSON.stringify(sid);
        const snameJson = JSON.stringify(sname);
        const ts = escapeHtml(e.ts || "");
        const reason = escapeHtml(e.reason || "");
        return `<div>[${ts}] <a href="javascript:void(0)" onclick='openServiceLogs(${sidJson},${snameJson})'>${snameHtml} (${sidHtml})</a>: ${reason}</div>`;
      }).join("");
    }

    function renderEvents(events) {
      const box = document.getElementById("eventsBox");
      if (!events || events.length === 0) {
        box.innerHTML = `<div class="text-muted">暂无事件日志</div>`;
        return;
      }
      box.innerHTML = events.map(e => {
        const sid = String(e.service_id || "");
        const sname = String(e.service_name || "");
        const sidHtml = escapeHtml(sid);
        const snameHtml = escapeHtml(sname);
        const sidJson = JSON.stringify(sid);
        const snameJson = JSON.stringify(sname);
        const ts = escapeHtml(e.ts || "");
        const level = escapeHtml(String(e.level || "").toUpperCase());
        const action = escapeHtml(e.action || "");
        const msg = escapeHtml(e.message || "");
        return `<div>[${ts}] [${level}] <a href="javascript:void(0)" onclick='openServiceEventLogs(${sidJson},${snameJson})'>${snameHtml} (${sidHtml})</a> ${action}: ${msg}</div>`;
      }).join("");
    }

    const logsState = { service_id: "", service_name: "", page: 1, page_size: 20 };
    const eventLogsState = { service_id: "", service_name: "", page: 1, page_size: 30 };

    async function fetchServiceLogs() {
      const qs = new URLSearchParams({
        service_id: logsState.service_id,
        page: String(logsState.page),
        page_size: String(logsState.page_size),
        days: "7"
      });
      return await fetchJson(`/api/errors?${qs.toString()}`);
    }

    async function openServiceLogs(serviceId, serviceName) {
      logsState.service_id = serviceId;
      logsState.service_name = serviceName;
      logsState.page = 1;
      await showLogsModal();
    }

    async function openServiceEventLogs(serviceId, serviceName) {
      eventLogsState.service_id = serviceId;
      eventLogsState.service_name = serviceName;
      eventLogsState.page = 1;
      await showEventLogsModal();
    }

    async function showLogsModal() {
      const data = await fetchServiceLogs();
      const modalId = "serviceLogsModal";
      const existed = document.getElementById(modalId);
      if (existed) existed.remove();
      const title = `${escapeHtml(logsState.service_name)} (${escapeHtml(logsState.service_id)}) - 7天错误日志`;
      const pages = data.pages || 1;
      const items = data.errors || [];
      const content = items.length
        ? items.map(e => `<div>[${escapeHtml(e.ts || "")}] ${escapeHtml(e.reason || "")}</div>`).join("")
        : `<div class="text-muted">暂无错误日志</div>`;

      const root = document.getElementById("overlayModalsRoot");
      root.insertAdjacentHTML("beforeend", `
        <div class="modal fade" id="${modalId}" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">${title}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="log-box border rounded p-2 bg-white" id="serviceLogsBox">${content}</div>
                <div class="d-flex justify-content-between align-items-center mt-3">
                  <div class="text-muted small">第 ${logsState.page}/${pages} 页，每页 ${logsState.page_size} 条，共 ${data.total || 0} 条</div>
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" id="logsPrev">上一页</button>
                    <button class="btn btn-outline-secondary" id="logsNext">下一页</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `);

      const el = document.getElementById(modalId);
      const modal = new bootstrap.Modal(el);
      el.addEventListener("hidden.bs.modal", () => el.remove(), { once: true });
      modal.show();

      const prevBtn = document.getElementById("logsPrev");
      const nextBtn = document.getElementById("logsNext");
      prevBtn.disabled = logsState.page <= 1;
      nextBtn.disabled = logsState.page >= pages;

      prevBtn.onclick = async () => {
        if (logsState.page <= 1) return;
        logsState.page -= 1;
        el.remove();
        await showLogsModal();
      };
      nextBtn.onclick = async () => {
        if (logsState.page >= pages) return;
        logsState.page += 1;
        el.remove();
        await showLogsModal();
      };
    }

    async function fetchServiceEventLogs() {
      const qs = new URLSearchParams({
        service_id: eventLogsState.service_id,
        page: String(eventLogsState.page),
        page_size: String(eventLogsState.page_size),
        days: "7"
      });
      return await fetchJson(`/api/events?${qs.toString()}`);
    }

    async function showEventLogsModal() {
      const data = await fetchServiceEventLogs();
      const modalId = "serviceEventLogsModal";
      const existed = document.getElementById(modalId);
      if (existed) existed.remove();
      const title = `${escapeHtml(eventLogsState.service_name)} (${escapeHtml(eventLogsState.service_id)}) - 7天事件日志`;
      const pages = data.pages || 1;
      const items = data.events || [];
      const content = items.length
        ? items.map(e => `<div>[${escapeHtml(e.ts || "")}] [${escapeHtml(String(e.level || "").toUpperCase())}] ${escapeHtml(e.action || "")}: ${escapeHtml(e.message || "")}</div>`).join("")
        : `<div class="text-muted">暂无事件日志</div>`;

      const root = document.getElementById("overlayModalsRoot");
      root.insertAdjacentHTML("beforeend", `
        <div class="modal fade" id="${modalId}" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">${title}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="log-box border rounded p-2 bg-white">${content}</div>
                <div class="d-flex justify-content-between align-items-center mt-3">
                  <div class="text-muted small">第 ${eventLogsState.page}/${pages} 页</div>
                  <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-secondary" id="eventLogPrev" ${eventLogsState.page <= 1 ? "disabled" : ""}>上一页</button>
                    <button class="btn btn-outline-secondary" id="eventLogNext" ${eventLogsState.page >= pages ? "disabled" : ""}>下一页</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `);
      const modal = new bootstrap.Modal(document.getElementById(modalId));
      modal.show();
      document.getElementById("eventLogPrev").onclick = async () => {
        if (eventLogsState.page <= 1) return;
        eventLogsState.page -= 1;
        document.getElementById(modalId).remove();
        await showEventLogsModal();
      };
      document.getElementById("eventLogNext").onclick = async () => {
        if (eventLogsState.page >= pages) return;
        eventLogsState.page += 1;
        document.getElementById(modalId).remove();
        await showEventLogsModal();
      };
      document.getElementById(modalId).addEventListener("hidden.bs.modal", () => {
        document.getElementById(modalId).remove();
      });
    }

    async function loadAll() {
      if (state.inflight) return;
      state.inflight = true;
      try {
        const servicesData = await fetchServices();
        const pages = Math.max(Number(servicesData.pages || 1), 1);
        // 如果筛选后当前页越界，则先回退到有效页再重载。
        if (state.page > pages) {
          state.page = pages;
          state.inflight = false;
          return await loadAll();
        }
        renderServices(servicesData.services || [], servicesData.total || 0, servicesData.pages || 1);
        const errorsData = await fetchRecentErrors();
        renderErrors(errorsData.errors || []);
        const eventsData = await fetchRecentEvents();
        renderEvents(eventsData.events || []);

        document.getElementById("pagePrev").disabled = state.page <= 1;
        document.getElementById("pageNext").disabled = state.page >= pages;
        const ts = new Date();
        const hh = String(ts.getHours()).padStart(2, "0");
        const mm = String(ts.getMinutes()).padStart(2, "0");
        const ss = String(ts.getSeconds()).padStart(2, "0");
        const lr = document.getElementById("lastRefresh");
        if (lr) lr.textContent = `${hh}:${mm}:${ss}`;
      } catch (e) {
        try {
          const msg = String(e && e.message ? e.message : e);
          const box = document.getElementById("errorsBox");
          if (box) box.innerHTML = `<div class="text-danger">刷新失败：${escapeHtml(msg)}</div>`;
        } catch {}
      } finally {
        state.inflight = false;
      }
    }

    function bindFilters() {
      const pageSize = document.getElementById("pageSize");
      if (pageSize) pageSize.value = String(state.page_size);
      if (pageSize) pageSize.onchange = async () => {
        const v = Number(pageSize.value);
        if (Number.isFinite(v) && v > 0) state.page_size = v;
        state.page = 1;
        await loadAll();
      };
      const q = document.getElementById("filterQ");
      if (q) q.value = state.q;
      if (q) q.onkeydown = async (e) => {
        if (e.key !== "Enter") return;
        document.getElementById("applyFilters").click();
      };
      let qTimer = null;
      if (q) q.oninput = async () => {
        if (qTimer) clearTimeout(qTimer);
        qTimer = setTimeout(() => {
          document.getElementById("applyFilters").click();
        }, 400);
      };
      const autoApply = () => document.getElementById("applyFilters").click();
      const cat = document.getElementById("filterCategory");
      const failure = document.getElementById("filterFailure");
      const st = document.getElementById("filterStatus");
      const onlyFailed = document.getElementById("filterOnlyFailed");
      if (cat) cat.onchange = autoApply;
      if (failure) failure.onchange = autoApply;
      if (st) st.onchange = autoApply;
      if (onlyFailed) onlyFailed.onchange = autoApply;
      document.getElementById("applyFilters").onclick = async () => {
        state.q = String(document.getElementById("filterQ").value || "").trim();
        state.category = document.getElementById("filterCategory").value;
        state.on_failure = document.getElementById("filterFailure").value;
        state.status = document.getElementById("filterStatus").value;
        state.only_failed = document.getElementById("filterOnlyFailed").checked;
        state.page = 1;
        await loadAll();
      };
      document.getElementById("resetFilters").onclick = async () => {
        document.getElementById("filterQ").value = "";
        document.getElementById("filterCategory").value = "all";
        document.getElementById("filterFailure").value = "all";
        document.getElementById("filterStatus").value = "all";
        document.getElementById("filterOnlyFailed").checked = false;
        state.q = "";
        state.category = "all";
        state.on_failure = "all";
        state.status = "all";
        state.only_failed = false;
        state.page = 1;
        await loadAll();
      };
      document.getElementById("pagePrev").onclick = async () => {
        if (state.page <= 1) return;
        state.page -= 1;
        await loadAll();
      };
      document.getElementById("pageNext").onclick = async () => {
        state.page += 1;
        await loadAll();
      };
    }

    initResizableColumns("servicesTable", "hbmon_servicesTable_colwidths");
    initServicesHScrollSync();
    bindFilters();
    loadAll();

    (function enableDragScroll() {
      const wrap = document.getElementById("servicesTableWrap");
      if (!wrap) return;
      let down = false;
      let startX = 0;
      let startScroll = 0;
      let moved = 0;
      wrap.addEventListener("mousedown", (e) => {
        if (e.button !== 0) return;
        down = true;
        moved = 0;
        startX = e.clientX;
        startScroll = wrap.scrollLeft;
        state.dragScrolling = false;
      });
      window.addEventListener("mousemove", (e) => {
        if (!down) return;
        const dx = e.clientX - startX;
        moved = Math.max(moved, Math.abs(dx));
        if (moved > 6) state.dragScrolling = true;
        wrap.scrollLeft = startScroll - dx;
      });
      window.addEventListener("mouseup", () => {
        down = false;
        setTimeout(() => { state.dragScrolling = false; }, 0);
      });
    })();

    setInterval(() => {
      const anyModalOpen = !!document.querySelector(".modal.show");
      if (anyModalOpen) return;
      if (state.inflight) return;
      loadAll();
    }, 3000);

    function ensureAdminModal() {
      if (document.getElementById("adminModal")) return;
      document.getElementById("overlayModalsRoot").insertAdjacentHTML("beforeend", `
        <div class="modal fade" id="adminModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">管理</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <ul class="nav nav-tabs" role="tablist">
                  <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabUsers" type="button" role="tab">用户</button></li>
                  <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabBindings" type="button" role="tab">服务绑定</button></li>
                </ul>
                <div class="tab-content pt-3">
                  <div class="tab-pane fade show active" id="tabUsers" role="tabpanel">
                    <div class="row g-3">
                      <div class="col-12 col-lg-4">
                        <div class="card">
                          <div class="card-header">新建用户</div>
                          <div class="card-body">
                            <div class="mb-2">
                              <label class="form-label mb-1">账号</label>
                              <input class="form-control form-control-sm" id="newUserName">
                            </div>
                            <div class="mb-2">
                              <label class="form-label mb-1">密码</label>
                              <input class="form-control form-control-sm" id="newUserPwd" type="password">
                            </div>
                            <div class="mb-3">
                              <label class="form-label mb-1">角色</label>
                              <select class="form-select form-select-sm" id="newUserRole">
                                <option value="user">普通用户</option>
                                <option value="admin">超管</option>
                              </select>
                            </div>
                            <button class="btn btn-primary btn-sm w-100" id="createUserBtn">创建</button>
                          </div>
                        </div>
                      </div>
                      <div class="col-12 col-lg-8">
                        <div class="card">
                          <div class="card-header d-flex justify-content-between align-items-center">
                            <div>用户列表</div>
                            <button class="btn btn-outline-secondary btn-sm" id="reloadUsersBtn">刷新</button>
                          </div>
                          <div class="card-body p-0">
                            <div class="table-responsive">
                              <table class="table table-sm mb-0 align-middle">
                                <thead class="table-light"><tr><th>账号</th><th>角色</th><th style="width: 140px;">运维权限</th><th style="width: 220px;">操作</th></tr></thead>
                                <tbody id="usersBody"></tbody>
                              </table>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="tab-pane fade" id="tabBindings" role="tabpanel">
                    <div class="card">
                      <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                          服务绑定（填写账号，多个用英文逗号分隔）
                          <span class="text-muted small ms-2" id="bindingsSaveHint">-</span>
                        </div>
                        <div class="d-flex gap-2">
                          <button class="btn btn-primary btn-sm" id="saveBindingsBtn">保存变更</button>
                          <button class="btn btn-outline-secondary btn-sm" id="reloadBindingsBtn">刷新</button>
                        </div>
                      </div>
                      <div class="card-body p-0">
                        <div class="table-responsive">
                          <table class="table table-sm mb-0 align-middle">
                            <thead class="table-light"><tr><th style="width: 220px;">服务ID</th><th>绑定用户</th><th style="width: 260px;">检测频率</th></tr></thead>
                            <tbody id="bindingsBody"></tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `);
    }

    async function loadUsers() {
      const data = await fetchJson("/api/admin/users");
      const body = document.getElementById("usersBody");
      body.innerHTML = (data.users || []).map(u => {
        const username = String(u.username || "");
        const name = escapeHtml(username);
        const role = escapeHtml(u.role || "");
        const canControl = !!u.can_control;
        const disabled = username === "admin" ? "disabled" : "";
        const usernameJson = JSON.stringify(username);
        return `<tr>
          <td><code>${name}</code></td>
          <td>${role}</td>
          <td>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" ${canControl ? "checked" : ""} ${disabled} onchange='setUserControl(${usernameJson}, this.checked)'>
              <label class="form-check-label">允许</label>
            </div>
          </td>
          <td>
            <div class="d-flex gap-1">
              <button class="btn btn-outline-primary btn-sm" onclick='resetUserPwd(${usernameJson})' ${disabled}>改密码</button>
              <button class="btn btn-outline-danger btn-sm" onclick='deleteUser(${usernameJson})' ${disabled}>删除</button>
            </div>
          </td>
        </tr>`;
      }).join("") || `<tr><td colspan="4" class="text-center text-muted py-3">暂无用户</td></tr>`;
    }

    async function loadBindings() {
      const data = await fetchJson("/api/admin/bindings");
      const schedules = await fetchJson("/api/admin/schedules");
      const bindings = data.bindings || {};
      const base = schedules.base || {};
      const overrides = schedules.overrides || {};
      const enabled = schedules.enabled || {};
      const services = data.services || [];
      const body = document.getElementById("bindingsBody");
      const hint = document.getElementById("bindingsSaveHint");
      body.innerHTML = services.map(sid => {
        const v = (bindings[sid] || []).join(",");
        const sidKey = safeId(sid);
        const sidJson = JSON.stringify(String(sid));
        const baseValue = String(overrides[sid] || base[sid] || "").trim();
        const isEnabled = Object.prototype.hasOwnProperty.call(enabled, sid) ? !!enabled[sid] : (String(baseValue).toLowerCase() !== "off");
        const scheduleValue = isEnabled ? baseValue : "off";
        return `<tr>
          <td><code>${escapeHtml(sid)}</code></td>
          <td>
            <input class="form-control form-control-sm" value="${escapeHtml(v)}" id="bind_${sidKey}" data-base="${escapeHtml(v)}">
          </td>
          <td>
            <div class="input-group input-group-sm">
              <span class="input-group-text">频率</span>
              <input class="form-control" value="${escapeHtml(scheduleValue)}" placeholder="30m / 10s / daily@02:30 / off(关闭自动检测)" id="sched_${sidKey}" data-base="${escapeHtml(scheduleValue)}">
            </div>
            <div class="form-check form-switch mt-1">
              <input class="form-check-input" type="checkbox" ${String(scheduleValue).toLowerCase()==="off" ? "" : "checked"} onchange='toggleAutoCheck(${sidJson}, this.checked)'>
              <label class="form-check-label">自动检测</label>
            </div>
          </td>
        </tr>`;
      }).join("") || `<tr><td colspan="3" class="text-center text-muted py-3">暂无服务</td></tr>`;
      if (hint) hint.textContent = "修改后自动保存，或点“保存变更”批量保存";
      initBindingsAutoSave(services);
    }

    async function createUser() {
      const username = document.getElementById("newUserName").value.trim();
      const password = document.getElementById("newUserPwd").value;
      const role = document.getElementById("newUserRole").value;
      const data = await fetchJson("/api/admin/users", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password, role, can_control: false })
      });
      alert(data.message || "ok");
      document.getElementById("newUserName").value = "";
      document.getElementById("newUserPwd").value = "";
      await loadUsers();
      await loadBindings();
    }

    async function setUserControl(username, canControl) {
      const data = await fetchJson(`/api/admin/users/${encodeURIComponent(username)}/control`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ can_control: !!canControl })
      });
      if (data && data.message && data.message !== "ok") alert(data.message);
      await loadUsers();
    }

    async function deleteUser(username) {
      if (!confirm(`确认删除用户 ${username}？`)) return;
      const data = await fetchJson(`/api/admin/users/${encodeURIComponent(username)}`, { method: "DELETE" });
      alert(data.message || "ok");
      await loadUsers();
      await loadBindings();
    }

    async function resetUserPwd(username) {
      const pwd = prompt(`为 ${username} 设置新密码（至少4位）：`);
      if (!pwd) return;
      const data = await fetchJson(`/api/admin/users/${encodeURIComponent(username)}/password`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password: pwd })
      });
      alert(data.message || "ok");
    }

    const bindingsSaveState = { timers: {}, dirty: new Set() };

    function setBindingsHint(text) {
      const hint = document.getElementById("bindingsSaveHint");
      if (hint) hint.textContent = String(text || "-");
    }

    function parseUsers(input) {
      return String(input || "")
        .split(",")
        .map(x => x.trim())
        .filter(Boolean);
    }

    function getBindValue(sid) {
      const el = document.getElementById(`bind_${safeId(sid)}`);
      return el ? String(el.value || "") : "";
    }

    function getSchedValue(sid) {
      const el = document.getElementById(`sched_${safeId(sid)}`);
      return el ? String(el.value || "").trim() : "";
    }

    function isRowDirty(sid) {
      const bindEl = document.getElementById(`bind_${safeId(sid)}`);
      const schedEl = document.getElementById(`sched_${safeId(sid)}`);
      const baseBind = bindEl ? String(bindEl.dataset.base || "") : "";
      const baseSched = schedEl ? String(schedEl.dataset.base || "") : "";
      const curBind = bindEl ? String(bindEl.value || "") : "";
      const curSched = schedEl ? String(schedEl.value || "").trim() : "";
      return (curBind !== baseBind) || (curSched !== baseSched);
    }

    async function saveOneBindingAndSchedule(sid) {
      const users = parseUsers(getBindValue(sid));
      const check_schedule = getSchedValue(sid);
      await fetchJson("/api/admin/bindings", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ service_id: sid, users })
      });
      await fetchJson("/api/admin/schedules", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ service_id: sid, check_schedule })
      });
      const bindEl = document.getElementById(`bind_${safeId(sid)}`);
      const schedEl = document.getElementById(`sched_${safeId(sid)}`);
      if (bindEl) bindEl.dataset.base = String(bindEl.value || "");
      if (schedEl) schedEl.dataset.base = String(schedEl.value || "").trim();
      bindingsSaveState.dirty.delete(String(sid));
    }

    function scheduleAutoSave(sid) {
      sid = String(sid || "");
      if (!sid) return;
      bindingsSaveState.dirty.add(sid);
      setBindingsHint(`有 ${bindingsSaveState.dirty.size} 个服务待保存`);
      if (bindingsSaveState.timers[sid]) clearTimeout(bindingsSaveState.timers[sid]);
      bindingsSaveState.timers[sid] = setTimeout(async () => {
        if (!isRowDirty(sid)) {
          bindingsSaveState.dirty.delete(sid);
          setBindingsHint(bindingsSaveState.dirty.size ? `有 ${bindingsSaveState.dirty.size} 个服务待保存` : "已保存");
          return;
        }
        try {
          await saveOneBindingAndSchedule(sid);
          await loadAll();
          setBindingsHint(bindingsSaveState.dirty.size ? `有 ${bindingsSaveState.dirty.size} 个服务待保存` : "已保存");
        } catch (e) {
          setBindingsHint(`保存失败：${String(e && e.message ? e.message : e)}`);
        }
      }, 800);
    }

    function initBindingsAutoSave(services) {
      (services || []).forEach(sid => {
        const bindEl = document.getElementById(`bind_${safeId(sid)}`);
        const schedEl = document.getElementById(`sched_${safeId(sid)}`);
        if (bindEl) {
          bindEl.oninput = () => scheduleAutoSave(sid);
          bindEl.onblur = () => scheduleAutoSave(sid);
          bindEl.onkeydown = (e) => { if (e && e.key === "Enter") scheduleAutoSave(sid); };
        }
        if (schedEl) {
          schedEl.oninput = () => scheduleAutoSave(sid);
          schedEl.onblur = () => scheduleAutoSave(sid);
          schedEl.onkeydown = (e) => { if (e && e.key === "Enter") scheduleAutoSave(sid); };
        }
      });
    }

    async function saveAllBindingsChanges() {
      const services = Array.from(document.querySelectorAll("#bindingsBody tr td:first-child code")).map(x => String(x.textContent || "").trim()).filter(Boolean);
      const dirty = services.filter(sid => isRowDirty(sid));
      if (!dirty.length) {
        setBindingsHint("没有变更");
        return;
      }
      setBindingsHint(`保存中（${dirty.length}）...`);
      try {
        for (const sid of dirty) {
          await saveOneBindingAndSchedule(sid);
        }
        await loadAll();
        setBindingsHint("已保存");
      } catch (e) {
        setBindingsHint(`保存失败：${String(e && e.message ? e.message : e)}`);
      }
    }

    function autoKey(serviceId) {
      return `auto_sched_prev:${String(serviceId || "")}`;
    }

    async function toggleAutoCheck(serviceId, enabled) {
      const sid = String(serviceId || "");
      const schedEl = document.getElementById(`sched_${safeId(sid)}`);
      const current = String(schedEl ? schedEl.value : "").trim();
      if (!enabled) {
        try { localStorage.setItem(autoKey(sid), current && current.toLowerCase() !== "off" ? current : ""); } catch {}
        if (schedEl) schedEl.value = "off";
      } else {
        let prev = "";
        try { prev = String(localStorage.getItem(autoKey(sid)) || "").trim(); } catch {}
        if (schedEl) schedEl.value = prev || "";
      }
      await fetchJson("/api/admin/schedules", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ service_id: sid, check_schedule: String(schedEl ? schedEl.value : "").trim() })
      });
      await loadAll();
      await loadBindings();
    }

    async function toggleAutoCheckRow(serviceId, enabled) {
      const sid = String(serviceId || "");
      const svc = serviceIndex[sid] || {};
      const current = String((svc.check_schedule || "")).trim();
      if (!enabled) {
        try { localStorage.setItem(autoKey(sid), current && current.toLowerCase() !== "off" ? current : ""); } catch {}
        await fetchJson("/api/admin/schedules", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ service_id: sid, check_schedule: "off" })
        });
      } else {
        let prev = "";
        try { prev = String(localStorage.getItem(autoKey(sid)) || "").trim(); } catch {}
        await fetchJson("/api/admin/schedules", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ service_id: sid, check_schedule: prev || "" })
        });
      }
      await loadAll();
    }

    async function editScheduleRow(serviceId) {
      const sid = String(serviceId || "");
      const svc = serviceIndex[sid] || {};
      const base = String(svc.base_check_schedule || "").trim();
      const current = String(svc.check_schedule || "").trim();
      const shown = svc.auto_check ? (current || base || "30m") : "off";
      const input = prompt("请输入检测频率（10s/5m/1h/daily@02:30/weekly@mon 03:00；off=关闭自动检测；留空=恢复默认）", shown);
      if (input === null) return;
      const next = String(input).trim();
      if (next && next.toLowerCase() !== "off") {
        try { localStorage.setItem(autoKey(sid), next); } catch {}
      } else if (next.toLowerCase() === "off" && shown && shown.toLowerCase() !== "off") {
        try { localStorage.setItem(autoKey(sid), shown); } catch {}
      }
      await fetchJson("/api/admin/schedules", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ service_id: sid, check_schedule: next })
      });
      await loadAll();
    }

    async function toggleAutoRestartRow(serviceId, enabled) {
      const sid = String(serviceId || "");
      await fetchJson("/api/admin/failure_policy", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ service_id: sid, auto_restart: !!enabled })
      });
      await loadAll();
    }

    if (currentUser && currentUser.role === "admin") {
      const btn = document.getElementById("openAdmin");
      if (btn) {
        btn.onclick = async () => {
          ensureAdminModal();
          document.getElementById("createUserBtn").onclick = createUser;
          document.getElementById("reloadUsersBtn").onclick = loadUsers;
          document.getElementById("reloadBindingsBtn").onclick = loadBindings;
          document.getElementById("saveBindingsBtn").onclick = saveAllBindingsChanges;
          await loadUsers();
          await loadBindings();
          const modal = new bootstrap.Modal(document.getElementById("adminModal"));
          modal.show();
        };
      }
      const bulkEnableCapable = document.getElementById("bulkEnableCapable");
      const bulkDisableAll = document.getElementById("bulkDisableAll");
      const bulkEnableAll = document.getElementById("bulkEnableAll");
      if (bulkEnableCapable) bulkEnableCapable.onclick = async () => { await bulkSetOpsMode("enable_capable"); };
      if (bulkDisableAll) bulkDisableAll.onclick = async () => { await bulkSetOpsMode("disable_all"); };
      if (bulkEnableAll) bulkEnableAll.onclick = async () => { await bulkSetOpsMode("enable_all"); };
    }

    const changePwdBtn = document.getElementById("changeMyPwd");
    if (changePwdBtn) {
      changePwdBtn.onclick = async () => {
        const pwd = prompt("设置新密码（至少4位）：");
        if (!pwd) return;
        const data = await fetchJson("/api/me/password", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password: pwd })
        });
        alert(data.message || "ok");
      };
    }
  </script>
</body>
</html>
