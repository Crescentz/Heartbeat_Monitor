<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>内网服务心跳监控</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .status-running { color: #198754; font-weight: 600; }
    .status-error { color: #dc3545; font-weight: 600; }
    .status-unknown { color: #6c757d; font-weight: 600; }
    .log-box { max-height: 280px; overflow-y: auto; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }
    .service-row { cursor: pointer; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h3 class="mb-0">内网服务心跳监控中心</h3>
        <div class="text-muted small">服务数量：<span id="serviceCount">-</span></div>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">刷新</button>
      </div>
    </div>

    <div class="card shadow-sm mb-3">
      <div class="card-header">筛选</div>
      <div class="card-body">
        <div class="row g-2 align-items-end">
          <div class="col-12 col-md-3">
            <label class="form-label mb-1">类别</label>
            <select class="form-select form-select-sm" id="filterCategory">
              <option value="all">全部</option>
              <option value="api">API</option>
              <option value="web">网页</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label mb-1">失败策略</label>
            <select class="form-select form-select-sm" id="filterFailure">
              <option value="all">全部</option>
              <option value="alert">仅提示</option>
              <option value="restart">失败重启</option>
            </select>
          </div>
          <div class="col-12 col-md-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="filterOnlyFailed">
              <label class="form-check-label" for="filterOnlyFailed">只看失败服务</label>
            </div>
          </div>
          <div class="col-12 col-md-3 d-flex gap-2 justify-content-md-end">
            <button class="btn btn-primary btn-sm" id="applyFilters">应用</button>
            <button class="btn btn-outline-secondary btn-sm" id="resetFilters">重置</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm mb-3">
      <div class="card-header">服务状态</div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0 align-middle">
            <thead class="table-light">
              <tr>
                <th style="width: 70px;">序号</th>
                <th style="width: 220px;">服务</th>
                <th style="width: 90px;">类别</th>
                <th style="width: 120px;">策略</th>
                <th style="width: 120px;">状态</th>
                <th>检测地址</th>
                <th style="width: 140px;">运行时长</th>
                <th style="width: 120px;">故障率</th>
                <th style="width: 180px;">最后检测</th>
                <th style="width: 240px;">操作</th>
              </tr>
            </thead>
            <tbody id="servicesBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="text-muted small" id="paginationSummary"></div>
      <div class="btn-group btn-group-sm" role="group" aria-label="Pagination">
        <button class="btn btn-outline-secondary" id="pagePrev">上一页</button>
        <button class="btn btn-outline-secondary" id="pageNext">下一页</button>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-header">最近 10 条错误日志</div>
      <div class="card-body">
        <div class="log-box border rounded p-2 bg-white" id="errorsBox"></div>
      </div>
    </div>
  </div>

  <div id="modalsRoot"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function escapeHtml(x) {
      return String(x)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll("\"", "&quot;")
        .replaceAll("'", "&#039;");
    }

    function statusClass(s) {
      if (s === "Running") return "status-running";
      if (s === "Error") return "status-error";
      return "status-unknown";
    }

    const state = {
      category: "all",
      on_failure: "all",
      only_failed: false,
      page: 1,
      page_size: 5
    };

    async function controlService(serviceId, action) {
      const resp = await fetch(`/api/control/${serviceId}/${action}`, { method: 'POST' });
      const data = await resp.json();
      alert(data.message || (data.success ? 'OK' : 'Failed'));
      await loadAll();
    }

    function policyBadge(s) {
      if (!s.auto_check) return `<span class="badge text-bg-secondary">不自动</span>`;
      if (String(s.on_failure || "").toLowerCase() === "restart") return `<span class="badge text-bg-warning">失败重启</span>`;
      return `<span class="badge text-bg-info">仅提示</span>`;
    }

    function renderServices(services, total, pages) {
      document.getElementById("serviceCount").textContent = String(total);
      const summary = `第 ${state.page}/${pages || 1} 页（每页 ${state.page_size} 条），共 ${total} 条`;
      document.getElementById("paginationSummary").textContent = summary;

      const body = document.getElementById("servicesBody");
      if (!services || services.length === 0) {
        body.innerHTML = `<tr><td colspan="10" class="text-center text-muted py-4">暂无匹配服务</td></tr>`;
        document.getElementById("modalsRoot").innerHTML = "";
        return;
      }

      body.innerHTML = services.map((s, idx) => {
        const seq = (state.page - 1) * state.page_size + idx + 1;
        const cat = escapeHtml(s.category || "");
        const testApi = escapeHtml(s.test_api || "");
        const host = escapeHtml(s.host || "");
        const name = escapeHtml(s.name || s.id || "");
        const status = escapeHtml(s.status || "");
        const statusCls = statusClass(s.status);
        const canStart = !!s.can_start;
        const canStop = !!s.can_stop;
        const canRestart = !!s.can_restart;
        return `
          <tr class="service-row" data-bs-toggle="modal" data-bs-target="#detailModal_${escapeHtml(s.id)}">
            <td class="text-muted">${seq}</td>
            <td>
              <div class="fw-semibold">${name}</div>
              <div class="text-muted small">${host}</div>
            </td>
            <td class="text-muted small">${cat}</td>
            <td>${policyBadge(s)}</td>
            <td><span class="${statusCls}">${status}</span></td>
            <td class="text-truncate" style="max-width: 360px;">${testApi}</td>
            <td>${escapeHtml(s.uptime || "")}</td>
            <td>${escapeHtml(s.failure_rate || "")}</td>
            <td>${escapeHtml(s.last_check || "")}</td>
            <td>
              <div class="d-flex gap-1" onclick="event.stopPropagation()">
                <button class="btn btn-success btn-sm" ${canStart ? "" : "disabled"} onclick="controlService('${escapeHtml(s.id)}','start')">启动</button>
                <button class="btn btn-danger btn-sm" ${canStop ? "" : "disabled"} onclick="controlService('${escapeHtml(s.id)}','stop')">停止</button>
                <button class="btn btn-warning btn-sm" ${canRestart ? "" : "disabled"} onclick="controlService('${escapeHtml(s.id)}','restart')">重启</button>
                <button class="btn btn-info btn-sm" onclick="controlService('${escapeHtml(s.id)}','check')">检测</button>
              </div>
            </td>
          </tr>
        `;
      }).join("");

      const modalsRoot = document.getElementById("modalsRoot");
      modalsRoot.innerHTML = services.map(s => {
        const detail = escapeHtml(JSON.stringify(s.last_test_detail || {}, null, 2));
        return `
          <div class="modal fade" id="detailModal_${escapeHtml(s.id)}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">${escapeHtml(s.name || s.id)} 详情</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-2"><span class="text-muted">描述：</span>${escapeHtml(s.description || "")}</div>
                  <div class="mb-2"><span class="text-muted">配置文件：</span><code>${escapeHtml(s.config_path || "")}</code></div>
                  <div class="mb-2"><span class="text-muted">类别：</span><code>${escapeHtml(s.category || "")}</code></div>
                  <div class="mb-2"><span class="text-muted">自动检测：</span><code>${escapeHtml(String(!!s.auto_check))}</code></div>
                  <div class="mb-2"><span class="text-muted">失败策略：</span><code>${escapeHtml(s.on_failure || "")}</code></div>
                  <div class="mb-2"><span class="text-muted">检测地址：</span><code>${escapeHtml(s.test_api || "")}</code></div>
                  <div class="mb-2"><span class="text-muted">API 测试结果：</span></div>
                  <pre class="border rounded p-2 bg-light mb-0" style="white-space: pre-wrap;">${detail}</pre>
                  ${s.last_error ? `<div class="alert alert-danger mt-3 mb-0"><div class="fw-semibold">最后错误</div><div>${escapeHtml(s.last_error)}</div></div>` : ""}
                  <div class="d-flex justify-content-end mt-3">
                    <button class="btn btn-outline-primary btn-sm" onclick="openServiceLogs('${escapeHtml(s.id)}','${escapeHtml(s.name || s.id)}')">查看该服务7天错误日志</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join("");
    }

    async function fetchServices() {
      const qs = new URLSearchParams({
        category: state.category,
        on_failure: state.on_failure,
        only_failed: state.only_failed ? "1" : "0",
        page: String(state.page),
        page_size: String(state.page_size)
      });
      const resp = await fetch(`/api/services?${qs.toString()}`);
      return await resp.json();
    }

    async function fetchRecentErrors() {
      const resp = await fetch(`/api/errors?n=10&days=7`);
      return await resp.json();
    }

    function renderErrors(errors) {
      const box = document.getElementById("errorsBox");
      if (!errors || errors.length === 0) {
        box.innerHTML = `<div class="text-muted">暂无错误日志</div>`;
        return;
      }
      box.innerHTML = errors.map(e => {
        const sid = escapeHtml(e.service_id || "");
        const sname = escapeHtml(e.service_name || "");
        const ts = escapeHtml(e.ts || "");
        const reason = escapeHtml(e.reason || "");
        return `<div>[${ts}] <a href="javascript:void(0)" onclick="openServiceLogs('${sid}','${sname}')">${sname} (${sid})</a>: ${reason}</div>`;
      }).join("");
    }

    const logsState = { service_id: "", service_name: "", page: 1, page_size: 20 };

    async function fetchServiceLogs() {
      const qs = new URLSearchParams({
        service_id: logsState.service_id,
        page: String(logsState.page),
        page_size: String(logsState.page_size),
        days: "7"
      });
      const resp = await fetch(`/api/errors?${qs.toString()}`);
      return await resp.json();
    }

    async function openServiceLogs(serviceId, serviceName) {
      logsState.service_id = serviceId;
      logsState.service_name = serviceName;
      logsState.page = 1;
      await showLogsModal();
    }

    async function showLogsModal() {
      const data = await fetchServiceLogs();
      const modalId = "serviceLogsModal";
      const title = `${escapeHtml(logsState.service_name)} (${escapeHtml(logsState.service_id)}) - 7天错误日志`;
      const pages = data.pages || 1;
      const items = data.errors || [];
      const content = items.length
        ? items.map(e => `<div>[${escapeHtml(e.ts || "")}] ${escapeHtml(e.reason || "")}</div>`).join("")
        : `<div class="text-muted">暂无错误日志</div>`;

      const root = document.getElementById("modalsRoot");
      root.insertAdjacentHTML("beforeend", `
        <div class="modal fade" id="${modalId}" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">${title}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="log-box border rounded p-2 bg-white" id="serviceLogsBox">${content}</div>
                <div class="d-flex justify-content-between align-items-center mt-3">
                  <div class="text-muted small">第 ${logsState.page}/${pages} 页，每页 ${logsState.page_size} 条，共 ${data.total || 0} 条</div>
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" id="logsPrev">上一页</button>
                    <button class="btn btn-outline-secondary" id="logsNext">下一页</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `);

      const el = document.getElementById(modalId);
      const modal = new bootstrap.Modal(el);
      el.addEventListener("hidden.bs.modal", () => el.remove(), { once: true });
      modal.show();

      const prevBtn = document.getElementById("logsPrev");
      const nextBtn = document.getElementById("logsNext");
      prevBtn.disabled = logsState.page <= 1;
      nextBtn.disabled = logsState.page >= pages;

      prevBtn.onclick = async () => {
        if (logsState.page <= 1) return;
        logsState.page -= 1;
        el.remove();
        await showLogsModal();
      };
      nextBtn.onclick = async () => {
        if (logsState.page >= pages) return;
        logsState.page += 1;
        el.remove();
        await showLogsModal();
      };
    }

    async function loadAll() {
      const servicesData = await fetchServices();
      renderServices(servicesData.services || [], servicesData.total || 0, servicesData.pages || 1);
      const errorsData = await fetchRecentErrors();
      renderErrors(errorsData.errors || []);

      const pages = servicesData.pages || 1;
      document.getElementById("pagePrev").disabled = state.page <= 1;
      document.getElementById("pageNext").disabled = state.page >= pages;
    }

    function bindFilters() {
      document.getElementById("applyFilters").onclick = async () => {
        state.category = document.getElementById("filterCategory").value;
        state.on_failure = document.getElementById("filterFailure").value;
        state.only_failed = document.getElementById("filterOnlyFailed").checked;
        state.page = 1;
        await loadAll();
      };
      document.getElementById("resetFilters").onclick = async () => {
        document.getElementById("filterCategory").value = "all";
        document.getElementById("filterFailure").value = "all";
        document.getElementById("filterOnlyFailed").checked = false;
        state.category = "all";
        state.on_failure = "all";
        state.only_failed = false;
        state.page = 1;
        await loadAll();
      };
      document.getElementById("pagePrev").onclick = async () => {
        if (state.page <= 1) return;
        state.page -= 1;
        await loadAll();
      };
      document.getElementById("pageNext").onclick = async () => {
        state.page += 1;
        await loadAll();
      };
    }

    bindFilters();
    loadAll();
  </script>
</body>
</html>

